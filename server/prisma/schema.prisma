// Complete Prisma database schema for Concord Discord clone.
// Defines all models, relations, indexes, and cascade rules for the application.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER
// ============================================
model User {
  id                  String     @id @default(cuid())
  username            String     @unique @db.VarChar(32)
  discriminator       String     @db.VarChar(4)
  email               String     @unique @db.VarChar(255)
  passwordHash        String?    @db.VarChar(255)
  avatarUrl           String?    @db.VarChar(512)
  bannerUrl           String?    @db.VarChar(512)
  bannerColor         String?    @db.VarChar(7)
  bio                 String?    @db.VarChar(190)
  status              UserStatus @default(OFFLINE)
  customStatus        String?    @db.VarChar(128)
  customStatusEmoji   String?    @db.VarChar(64)
  isBot               Boolean    @default(false)
  isEmailVerified     Boolean    @default(false)
  emailVerifyToken    String?    @db.VarChar(255)
  passwordResetToken  String?    @db.VarChar(255)
  passwordResetExpiry DateTime?
  lastOnlineAt        DateTime?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  googleId String? @unique @db.VarChar(255)
  githubId String? @unique @db.VarChar(255)

  ownedServers           Server[]          @relation("ServerOwner")
  serverMembers          ServerMember[]
  messages               Message[]
  reactions              Reaction[]
  sentFriendRequests     FriendRequest[]   @relation("FriendRequestSender")
  receivedFriendRequests FriendRequest[]   @relation("FriendRequestReceiver")
  dmChannelMembers       DMChannelMember[]
  voiceStates            VoiceState[]
  readStates             ReadState[]
  bansGiven              Ban[]             @relation("BanExecutor")
  bansReceived           Ban[]             @relation("BannedUser")
  auditLogs              AuditLog[]
  webhooks               Webhook[]
  refreshTokens          RefreshToken[]

  @@unique([username, discriminator])
  @@index([email])
  @@index([status])
  @@map("users")
}

enum UserStatus {
  ONLINE
  IDLE
  DND
  INVISIBLE
  OFFLINE
}

// ============================================
// REFRESH TOKEN
// ============================================
model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique @db.VarChar(512)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ============================================
// SERVER (Guild)
// ============================================
model Server {
  id              String         @id @default(cuid())
  name            String         @db.VarChar(100)
  description     String?        @db.VarChar(1000)
  iconUrl         String?        @db.VarChar(512)
  bannerUrl       String?        @db.VarChar(512)
  ownerId         String
  owner           User           @relation("ServerOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  isPublic        Boolean        @default(false)
  vanityUrl       String?        @unique @db.VarChar(32)
  systemChannelId String?        @db.VarChar(255)
  memberCount     Int            @default(0)
  category        ServerCategory @default(OTHER)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  channels          Channel[]
  channelCategories ChannelCategory[]
  roles             Role[]
  members           ServerMember[]
  invites           Invite[]
  bans              Ban[]
  customEmojis      CustomEmoji[]
  auditLogs         AuditLog[]
  webhooks          Webhook[]

  @@index([ownerId])
  @@index([isPublic])
  @@index([name])
  @@map("servers")
}

enum ServerCategory {
  GAMING
  ENTERTAINMENT
  EDUCATION
  SCIENCE
  TECHNOLOGY
  MUSIC
  ART
  COMMUNITY
  OTHER
}

// ============================================
// CHANNEL CATEGORY
// ============================================
model ChannelCategory {
  id        String    @id @default(cuid())
  name      String    @db.VarChar(100)
  position  Int       @default(0)
  serverId  String
  server    Server    @relation(fields: [serverId], references: [id], onDelete: Cascade)
  channels  Channel[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([serverId])
  @@map("channel_categories")
}

// ============================================
// CHANNEL
// ============================================
model Channel {
  id         String           @id @default(cuid())
  name       String           @db.VarChar(100)
  topic      String?          @db.VarChar(1024)
  type       ChannelType
  position   Int              @default(0)
  isNsfw     Boolean          @default(false)
  slowMode   Int              @default(0)
  serverId   String?
  server     Server?          @relation(fields: [serverId], references: [id], onDelete: Cascade)
  categoryId String?
  category   ChannelCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  parentId   String?
  parent     Channel?         @relation("ChannelThreads", fields: [parentId], references: [id], onDelete: Cascade)
  threads    Channel[]        @relation("ChannelThreads")
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  messages            Message[]
  permissionOverrides PermissionOverride[]
  voiceStates         VoiceState[]
  readStates          ReadState[]
  webhooks            Webhook[]
  invites             Invite[]
  dmMembers           DMChannelMember[]

  @@index([serverId])
  @@index([categoryId])
  @@index([parentId])
  @@map("channels")
}

enum ChannelType {
  TEXT
  VOICE
  VIDEO
  FORUM
  ANNOUNCEMENT
  THREAD
  DM
  GROUP_DM
}

// ============================================
// PERMISSION OVERRIDE
// ============================================
model PermissionOverride {
  id         String               @id @default(cuid())
  channelId  String
  channel    Channel              @relation(fields: [channelId], references: [id], onDelete: Cascade)
  targetType PermissionTargetType
  targetId   String
  allow      BigInt               @default(0)
  deny       BigInt               @default(0)

  @@unique([channelId, targetType, targetId])
  @@index([channelId])
  @@map("permission_overrides")
}

enum PermissionTargetType {
  ROLE
  MEMBER
}

// ============================================
// MESSAGE
// ============================================
model Message {
  id        String      @id @default(cuid())
  content   String      @db.Text
  type      MessageType @default(DEFAULT)
  channelId String
  channel   Channel     @relation(fields: [channelId], references: [id], onDelete: Cascade)
  authorId  String
  author    User        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  replyToId String?
  replyTo   Message?    @relation("MessageReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replies   Message[]   @relation("MessageReplies")
  isPinned  Boolean     @default(false)
  isEdited  Boolean     @default(false)
  editedAt  DateTime?
  webhookId String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  attachments Attachment[]
  reactions   Reaction[]
  embeds      Embed[]
  mentions    Mention[]

  @@index([channelId, createdAt])
  @@index([authorId])
  @@index([channelId])
  @@map("messages")
}

enum MessageType {
  DEFAULT
  SYSTEM_JOIN
  SYSTEM_LEAVE
  SYSTEM_PIN
  SYSTEM_CHANNEL_NAME_CHANGE
  REPLY
  THREAD_CREATED
}

// ============================================
// ATTACHMENT
// ============================================
model Attachment {
  id        String   @id @default(cuid())
  messageId String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  fileName  String   @db.VarChar(255)
  fileSize  Int
  fileUrl   String   @db.VarChar(512)
  mimeType  String   @db.VarChar(128)
  width     Int?
  height    Int?
  createdAt DateTime @default(now())

  @@index([messageId])
  @@map("attachments")
}

// ============================================
// EMBED
// ============================================
model Embed {
  id           String    @id @default(cuid())
  messageId    String
  message      Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)
  type         String    @db.VarChar(32)
  title        String?   @db.VarChar(256)
  description  String?   @db.VarChar(4096)
  url          String?   @db.VarChar(512)
  color        Int?
  thumbnailUrl String?   @db.VarChar(512)
  imageUrl     String?   @db.VarChar(512)
  videoUrl     String?   @db.VarChar(512)
  authorName   String?   @db.VarChar(256)
  authorUrl    String?   @db.VarChar(512)
  authorIcon   String?   @db.VarChar(512)
  footerText   String?   @db.VarChar(2048)
  footerIcon   String?   @db.VarChar(512)
  fields       Json?
  timestamp    DateTime?
  createdAt    DateTime  @default(now())

  @@index([messageId])
  @@map("embeds")
}

// ============================================
// MENTION
// ============================================
model Mention {
  id        String      @id @default(cuid())
  messageId String
  message   Message     @relation(fields: [messageId], references: [id], onDelete: Cascade)
  type      MentionType
  targetId  String

  @@index([messageId])
  @@index([targetId])
  @@map("mentions")
}

enum MentionType {
  USER
  ROLE
  CHANNEL
  EVERYONE
  HERE
}

// ============================================
// REACTION
// ============================================
model Reaction {
  id        String   @id @default(cuid())
  messageId String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  emoji     String   @db.VarChar(64)
  isCustom  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@unique([messageId, userId, emoji])
  @@index([messageId])
  @@map("reactions")
}

// ============================================
// ROLE
// ============================================
model Role {
  id            String   @id @default(cuid())
  name          String   @db.VarChar(100)
  color         Int      @default(0)
  isHoisted     Boolean  @default(false)
  position      Int      @default(0)
  permissions   BigInt   @default(0)
  isMentionable Boolean  @default(false)
  isDefault     Boolean  @default(false)
  serverId      String
  server        Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  members ServerMember[] @relation("MemberRoles")

  @@index([serverId])
  @@index([position])
  @@map("roles")
}

// ============================================
// SERVER MEMBER
// ============================================
model ServerMember {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  serverId   String
  server     Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  nickname   String?  @db.VarChar(32)
  joinedAt   DateTime @default(now())
  isMuted    Boolean  @default(false)
  isDeafened Boolean  @default(false)

  roles Role[] @relation("MemberRoles")

  @@unique([userId, serverId])
  @@index([serverId])
  @@index([userId])
  @@map("server_members")
}

// ============================================
// FRIEND REQUEST
// ============================================
model FriendRequest {
  id         String              @id @default(cuid())
  senderId   String
  sender     User                @relation("FriendRequestSender", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId String
  receiver   User                @relation("FriendRequestReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  status     FriendRequestStatus @default(PENDING)
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt

  @@unique([senderId, receiverId])
  @@index([receiverId])
  @@index([senderId])
  @@map("friend_requests")
}

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
  BLOCKED
}

// ============================================
// DM CHANNEL MEMBER
// ============================================
model DMChannelMember {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  channelId String
  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  isOwner   Boolean  @default(false)
  joinedAt  DateTime @default(now())

  @@unique([userId, channelId])
  @@index([userId])
  @@index([channelId])
  @@map("dm_channel_members")
}

// ============================================
// INVITE
// ============================================
model Invite {
  code        String    @id @db.VarChar(16)
  serverId    String
  server      Server    @relation(fields: [serverId], references: [id], onDelete: Cascade)
  channelId   String
  channel     Channel   @relation(fields: [channelId], references: [id], onDelete: Cascade)
  inviterId   String    @db.VarChar(255)
  maxUses     Int?
  uses        Int       @default(0)
  maxAge      Int?
  isTemporary Boolean   @default(false)
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())

  @@index([serverId])
  @@index([code])
  @@map("invites")
}

// ============================================
// BAN
// ============================================
model Ban {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation("BannedUser", fields: [userId], references: [id], onDelete: Cascade)
  serverId   String
  server     Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  executorId String
  executor   User     @relation("BanExecutor", fields: [executorId], references: [id], onDelete: Cascade)
  reason     String?  @db.VarChar(512)
  createdAt  DateTime @default(now())

  @@unique([userId, serverId])
  @@index([serverId])
  @@map("bans")
}

// ============================================
// CUSTOM EMOJI
// ============================================
model CustomEmoji {
  id         String   @id @default(cuid())
  name       String   @db.VarChar(32)
  imageUrl   String   @db.VarChar(512)
  isAnimated Boolean  @default(false)
  serverId   String
  server     Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  uploaderId String   @db.VarChar(255)
  createdAt  DateTime @default(now())

  @@index([serverId])
  @@map("custom_emojis")
}

// ============================================
// READ STATE
// ============================================
model ReadState {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  channelId         String
  channel           Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  lastReadMessageId String?  @db.VarChar(255)
  mentionCount      Int      @default(0)
  updatedAt         DateTime @updatedAt

  @@unique([userId, channelId])
  @@index([userId])
  @@map("read_states")
}

// ============================================
// VOICE STATE
// ============================================
model VoiceState {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  channelId        String
  channel          Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  serverId         String?  @db.VarChar(255)
  isSelfMuted      Boolean  @default(false)
  isSelfDeafened   Boolean  @default(false)
  isServerMuted    Boolean  @default(false)
  isServerDeafened Boolean  @default(false)
  isStreaming      Boolean  @default(false)
  isVideoOn        Boolean  @default(false)
  joinedAt         DateTime @default(now())

  @@unique([userId])
  @@index([channelId])
  @@map("voice_states")
}

// ============================================
// AUDIT LOG
// ============================================
model AuditLog {
  id         String         @id @default(cuid())
  serverId   String
  server     Server         @relation(fields: [serverId], references: [id], onDelete: Cascade)
  executorId String
  executor   User           @relation(fields: [executorId], references: [id], onDelete: Cascade)
  action     AuditLogAction
  targetType String         @db.VarChar(32)
  targetId   String         @db.VarChar(255)
  changes    Json?
  reason     String?        @db.VarChar(512)
  createdAt  DateTime       @default(now())

  @@index([serverId])
  @@index([executorId])
  @@index([createdAt])
  @@map("audit_logs")
}

enum AuditLogAction {
  SERVER_UPDATE
  CHANNEL_CREATE
  CHANNEL_UPDATE
  CHANNEL_DELETE
  ROLE_CREATE
  ROLE_UPDATE
  ROLE_DELETE
  MEMBER_KICK
  MEMBER_BAN
  MEMBER_UNBAN
  MEMBER_ROLE_UPDATE
  INVITE_CREATE
  INVITE_DELETE
  WEBHOOK_CREATE
  WEBHOOK_UPDATE
  WEBHOOK_DELETE
  EMOJI_CREATE
  EMOJI_DELETE
  MESSAGE_PIN
  MESSAGE_UNPIN
  MESSAGE_DELETE
}

// ============================================
// WEBHOOK
// ============================================
model Webhook {
  id        String   @id @default(cuid())
  name      String   @db.VarChar(80)
  avatarUrl String?  @db.VarChar(512)
  token     String   @unique @db.VarChar(255)
  channelId String
  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  serverId  String
  server    Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  creatorId String
  creator   User     @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([channelId])
  @@index([serverId])
  @@map("webhooks")
}
